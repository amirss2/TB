# ูุฑุญูู ด: ุจูุจูุฏ ูพุงุฏุงุฑ ู ูุงฺฏูฺฏ - ุฎูุงุตู ุงุฌุฑุง

## ูุชุฌู ููุง

ุชูุงู ุงูุฒุงูุงุช ูุฑุญูู ด ุจุง ููููุช ูพุงุฏูโุณุงุฒ ุดุฏู ุงุณุช. ุณุณุชู ุงฺฉููู ูุงุจูุชโูุง ุฒุฑ ุฑุง ุฏุงุฑุฏ:

## โ ฑ. Graceful Shutdown/Resume (ูพุงุฏุงุฑ ุฏุฑ ุจุฑุงุจุฑ ุฑุงุณุชุงุฑุช)

### ูุดุฎุตุงุช ูพุงุฏูโุณุงุฒ ุดุฏู:

**ููฺฏุงู ุฎุงููุด ุดุฏู (Shutdown):**
- ุฐุฎุฑูโุณุงุฒ ฺฉุงูู ูุถุนุช ุณุณุชู ุฏุฑ ุฏุชุงุจุณ
- ุซุจุช ุชูุงู ูพูุฒุดูโูุง ุจุงุฒ (OPEN positions)
- ูุญุงุณุจู ู ุฐุฎุฑู ููุฌูุฏ ูููโุดุฏู (locked) ู ุฏุฑ ุฏุณุชุฑุณ (available)
- ุงุฌุฑุง ฺฉ Health Check ููุง ูุจู ุงุฒ ุฎุงููุด

**ููฺฏุงู ุฑูุดู ุดุฏู (Startup):**
- ุจุงุฒุงุจ ฺฉุงูู ููุฌูุฏ wallet ุงุฒ ุฏุชุงุจุณ
- ุชุดุฎุต ุฎูุฏฺฉุงุฑ ูพูุฒุดูโูุง ุจุงุฒ
- ูุญุงุณุจู ูุฌุฏุฏ used_balance ุงุฒ ูุฌููุน ุงุฑุฒุด ูพูุฒุดูโูุง ุจุงุฒ
- ุจุฑุฑุณ ู ุชุทุจู (reconciliation) ุงุชููุงุชฺฉ ููุฌูุฏโูุง
- ููุงุด ุฌุฒุฆุงุช ฺฉุงูู ูพูุฒุดูโูุง ุจุงุฒุงุจ ุดุฏู

**ูฺฺฏโูุง ฺฉูุฏ:**
- โ ุนููุงุช idempotent: ูโุชูุงู ฺูุฏู ุจุงุฑ ุฑุงุณุชุงุฑุช ฺฉุฑุฏ ุจุฏูู ูุดฺฉู
- โ ูฺ ุฏุงุฏูโุง ฺฏู ููโุดูุฏ
- โ ููุฌูุฏโูุง ููุดู ุตุญุญ ุงุณุช
- โ ุชุงุฑุฎฺู ุชุฑุงฺฉูุดโูุง ุญูุธ ูโุดูุฏ

**ูุซุงู ุฎุฑูุฌ ููฺฏุงู ุงุณุชุงุฑุช:**
```
================================================================================
INITIALIZING/RESTORING WALLET STATE
================================================================================
โ Restored wallet from database: demo balance = $102.50
โ Restored used_balance from 2 open positions: $50.00
   Open positions found:
   - BTCUSDT: LONG, Entry=$45123.45, Qty=0.000553, Value=$25.00
   - ETHUSDT: LONG, Entry=$2456.78, Qty=0.010178, Value=$25.00
โ Wallet reconciled: Total=$102.50, Available=$52.50, Locked=$50.00
โ RECONCILIATION: PASSED - Balance matches transaction history
================================================================================
```

## โ ฒ. Health Checks (ฺฏุฒุงุฑุด ุณูุงูุช ุณุณุชู ูุฑ ฑต ุฏููู)

### ูพุงุฑุงูุชุฑ ูุงุจู ุชูุธู:
```python
'health_check_interval_minutes': 15,  # ูุฑ 15 ุฏููู ฺฉุจุงุฑ
```

### ุงุทูุงุนุงุช ฺฏุฒุงุฑุด ุดุฏู:

**ฑ. ุฎูุงุตู ูพูุฒุดูโูุง:**
- ุชุนุฏุงุฏ ูพูุฒุดูโูุง OPEN (ูุซุงู: ฒ/ด)
- ุชุนุฏุงุฏ ุงุณูุงุช ุฎุงู
- ุฌุฒุฆุงุช ูุฑ ูพูุฒุดู ุจุง PnL ูุนู (ุจุนุฏ ุงุฒ ฺฉุณุฑ ฺฉุงุฑูุฒุฏูุง)

**ฒ. ูุถุนุช Wallet:**
- ููุฌูุฏ ฺฉู (Total Balance)
- ููุฌูุฏ ุฏุฑ ุฏุณุชุฑุณ (Available Balance)
- ููุฌูุฏ ูููโุดุฏู (Locked Balance)
- ูุฌููุน PnL ูุญูู ุดุฏู (Realized PnL)

**ณ. ุชุญูู PnL (ููู ุจุนุฏ ุงุฒ ฺฉุณุฑ ฺฉุงุฑูุฒุฏูุง):**
- PnL ูุญูู ูุดุฏู ุงุฒ ูพูุฒุดูโูุง ุจุงุฒ (Unrealized)
- PnL ูุญูู ุดุฏู ุงุฒ ูพูุฒุดูโูุง ุจุณุชู (Realized)
- ูุฌููุน ฺฉู PnL
- ุชูฺฉฺฉ: PnL ูุงุฎุงูุต / ฺฉู ูุฒููโูุง / PnL ุฎุงูุต

**ด. ูุชุฌู Reconciliation:**
- ุจุฑุฑุณ ูุฑููู: `sum(transactions) + initial_balance == total_balance`
- ุจุฑุฑุณ ูุฑููู: `total_balance - locked_balance == available_balance`
- ูุถุนุช: PASSED ุง FAILED (ุจุง ููุงุด ุงุฎุชูุงู)

**ูุซุงู ุฎุฑูุฌ Health Check:**
```
================================================================================
SYSTEM HEALTH CHECK
================================================================================
๐ POSITIONS: 2/4 OPEN (2 slots available)
   Position Details:
   - BTCUSDT: LONG, Entry=$45123.450000, Current=$45678.900000, 
     Net PnL=$0.5234 (Gross=$0.6012, Costs=$0.0778)
   - ETHUSDT: LONG, Entry=$2456.780000, Current=$2489.120000, 
     Net PnL=$0.3145 (Gross=$0.3890, Costs=$0.0745)
๐ฐ WALLET: Total=$102.50, Available=$52.50, Locked=$50.00
๐ PnL: Unrealized=$0.84, Realized=$2.50, Total=$3.34
โ RECONCILIATION: PASSED - Wallet balances are consistent
================================================================================
```

## โ ณ. ูุฒููโูุง ุฏุฑ ุชุตููโฺฏุฑ (Fee/Spread/Slippage)

### ูพฺฉุฑุจูุฏ ฺฉุงุฑูุฒุฏูุง:
```python
FEE_CONFIG = {
    'spot_trading': {
        'maker_fee': 0.0016,  # 0.16% (ฺฉุงุฑูุฒุฏ Maker)
        'taker_fee': 0.0026,  # 0.26% (ฺฉุงุฑูุฒุฏ Taker)
    },
    'spread': {
        'estimate_pct': 0.001,  # 0.1% (ุงุฎุชูุงู ููุช ุฎุฑุฏ/ูุฑูุด)
    },
    'slippage': {
        'estimate_pct': 0.0005,  # 0.05% (ุงุฎุชูุงู ุงุฌุฑุง ุณูุงุฑุด)
    }
}
```

### ูุญุงุณุจู PnL ุจุง ููู ูุฒููโูุง:
```python
# ูุฒููโูุง ูุญุงุณุจู ุดุฏู:
entry_fee = entry_value ร 0.0026       # ฺฉุงุฑูุฒุฏ ูุฑูุฏ
exit_fee = exit_value ร 0.0026         # ฺฉุงุฑูุฒุฏ ุฎุฑูุฌ
spread_cost = avg_value ร 0.001        # ูุฒูู spread
slippage_cost = avg_value ร 0.0005     # ูุฒูู slippage

# PnL ุฎุงูุต:
net_pnl = gross_pnl - (entry_fee + exit_fee + spread_cost + slippage_cost)
```

### ุงุณุชูุงุฏู ุฏุฑ ููู ุฌุง:
- โ Health Check: ููุงุด PnL ุฎุงูุต
- โ ุจุณุชู ูพูุฒุดู: ุงุณุชูุงุฏู ุงุฒ PnL ุฎุงูุต ุจุฑุง ุจูโุฑูุฒุฑุณุงู wallet
- โ ูุชุฑฺฉโูุง Performance: ููู ุจุฑ ุงุณุงุณ PnL ุฎุงูุต
- โ ุงุนุชุจุงุฑุณูุฌ ูุฏู: ูุนุงููู ุจุฑูุฏู = PnL ุฎุงูุต > 0

**ูุซุงู ุฎุฑูุฌ ูุญุงุณุจู PnL:**
```
PnL Calculation for BTCUSDT: 
Gross PnL=$0.6012 (+2.40%), 
Entry Fee=$0.0390, Exit Fee=$0.0427, 
Spread=$0.0050, Slippage=$0.0025, 
Total Costs=$0.0892, 
Net PnL=$0.5120 (+2.05%)
```

## โ ด. Max Positions ุจุง ูุงฺฏ ฺฉุงูู (ุฑุฏ ฺฉุฑุฏู ุณฺฏูุงู)

### ููฺฏุงู ฺฉู ด/ด ูพูุฒุดู ูพูุฑ ุงุณุช:

**ุงุทูุงุนุงุช ุณฺฏูุงู ุฑุฏ ุดุฏู:**
- ููุงุฏ (Symbol)
- ููุน ูุนุงููู (BUY/SELL)
- ุงุนุชูุงุฏ ูุฏู (Confidence) - ูุซูุงู ธฒ.ณูช
- ููุช
- ุฏูู ุฑุฏ: ููู ุงุณูุงุชโูุง ูพูุฑ ุงุณุช

**ููุงุณู ุจุง ูพูุฒุดูโูุง ูุนู:**
- ูุณุช ุชูุงู ูพูุฒุดูโูุง ุจุงุฒ
- ููุช ูุฑูุฏ ู ูุนู ูุฑ ูพูุฒุดู
- PnL ุฎุงูุต (ุจุนุฏ ุงุฒ ฺฉุงุฑูุฒุฏูุง)
- ุฏุฑุตุฏ ุณูุฏ/ุฒุงู

**ุฑุงูููุง ุนูู:**
- ูพุดููุงุฏ ุจุณุชู ูพูุฒุดูโูุง ุถุนู ุจุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ุงุณูุงุช

**ูุซุงู ุฎุฑูุฌ:**
```
================================================================================
โ๏ธ  MAX POSITIONS LIMIT REACHED (4/4)
REJECTED SIGNAL:
   Symbol: SOLUSDT
   Type: BUY (LONG)
   Confidence: 0.823 (82.3%)
   Price: $98.456789
   Reason: All position slots occupied

CURRENT OPEN POSITIONS:
   1. BTCUSDT: LONG, Entry=$45123.450000, Current=$45678.900000, 
      Net PnL=$0.5234 (+2.09%)
   2. ETHUSDT: LONG, Entry=$2456.780000, Current=$2489.120000, 
      Net PnL=$0.3145 (+1.28%)
   3. DOGEUSDT: LONG, Entry=$0.123456, Current=$0.125678, 
      Net PnL=$0.0234 (+1.90%)
   4. ADAUSDT: LONG, Entry=$0.567890, Current=$0.545678, 
      Net PnL=-$0.2145 (-3.78%)

ACTION REQUIRED: Close existing positions to free up slots for new signals
================================================================================
```

**ูุฒุงุง:**
- ูโุจูุฏ ฺฉุฏุงู ุณฺฏูุงูโูุง ูู ุงุฒ ุฏุณุช ูโุฑูุฏ
- ูโุชูุงูุฏ ุชุตูู ุจฺฏุฑุฏ ฺฉุฏุงู ูพูุฒุดู ุฑุง ุจุจูุฏุฏ
- ุดูุงูุช ฺฉุงูู ุฏุฑ ุชุตููุงุช ุณุณุชู

## ูุณุชูุฏุงุช

๐ **STAGE4_IMPLEMENTATION.md** (ุงูฺฏูุณ): ุฑุงูููุง ฺฉุงูู ูพุงุฏูโุณุงุฒ ุจุง ูุซุงูโูุง

## ุงููุช

โ **ุจุฑุฑุณ CodeQL**: ูฺ ุขุณุจโูพุฐุฑ ุงููุช ุงูุช ูุดุฏ

## ุชุณุช

โ ฺฉุงููพุงู ฺฉุฏ ุจุฏูู ุฎุทุง  
โ ุงุนุชุจุงุฑุณูุฌ ุณุงุฎุชุงุฑ  
โ ุชุณุช ุนููุงุช ุฏุชุงุจุณ  
โ ููู ูุชุฏูุง ููุฑุฏ ูุงุฒ ููุฌูุฏ ุงุณุช  

## ุจุฏูู ุชุบุฑุงุช ูุฎุฑุจ

โ ููู ูุงุจูุชโูุง ูุจู ุญูุธ ุดุฏู  
โ ุณุงุฒฺฏุงุฑ ุจุง ูุณุฎู ูุจู  
โ ุชูุธูุงุช ุงุฎุชุงุฑ (ูุงุจู ุชูุธู)  

## ูุญูู ุงุณุชูุงุฏู

### ุชูุธู ูุงุตูู Health Check:
```python
# ุฏุฑ config/settings.py
TRADING_CONFIG = {
    'health_check_interval_minutes': 15,  # ูุฑ 15 ุฏููู (ูุงุจู ุชุบุฑ)
    # ...
}
```

### ูุดุงูุฏู ูุงฺฏโูุง:
ุณุณุชู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุฏุฑ ููุงุตู ูุดุฎุต ฺฏุฒุงุฑุด ูโุฏูุฏ. ููุท ฺฉุงู ุงุณุช ุจุฑูุงูู ุฑุง ุงุฌุฑุง ฺฉูุฏ:
```bash
python main.py
```

## ุฎูุงุตู ุชุญูู

โ **Graceful Shutdown/Resume**: ฺฉุงูู ุจุง state persistence ู idempotent recovery  
โ **Health Checks**: ฺฏุฒุงุฑุดโูุง ุฌุงูุน ูุฑ ฑต ุฏููู ุจุง ุชูุงู ูุชุฑฺฉโูุง ุฏุฑุฎูุงุณุช  
โ **ูุฒููโูุง ุฏุฑ ูุญุงุณุจุงุช**: ููู ูุญุงุณุจุงุช ุจุง PnL ุฎุงูุต ูพุณ ุงุฒ ฺฉุณุฑ fee/spread/slippage  
โ **Max Positions Logging**: ูุงฺฏโูุง ุชูุตู ุฑุฏ ุณฺฏูุงู ุจุง ููุงุณู ูพูุฒุดูโูุง  

ุณุณุชู ุงฺฉููู ุขูุงุฏู ุชููุฏ (production-ready) ุจุง ูุงุจูุชโูุง ูู ูพุงุฏุงุฑุ ูุงูุชูุฑูฺฏ ู ูุงฺฏูฺฏ ุงุณุช.

## ูุงูโูุง ุชุบุฑ ุงูุชู

1. `config/settings.py`: ุงุถุงูู ุดุฏู `health_check_interval_minutes`
2. `trading/engine.py`: 
   - `comprehensive_health_check()`: Health check ุฌุงูุน
   - `_save_shutdown_state()`: ุฐุฎุฑู state ููฺฏุงู shutdown
   - `_initialize_wallet()`: ุจูุจูุฏ ุจุงุฒุงุจ wallet
   - `_process_buy_signal()`: ูุงฺฏ ุชูุตู max positions
3. `main.py`: ฺฉูพุงุฑฺูโุณุงุฒ health check ุฏุฑ main loop
4. `STAGE4_IMPLEMENTATION.md`: ูุณุชูุฏุงุช ุงูฺฏูุณ
5. `STAGE4_FARSI_SUMMARY.md`: ุงู ูุณุชูุฏ (ูุงุฑุณ)

ุชูุงู ุชุบุฑุงุช committed ู pushed ุดุฏูโุงูุฏ. ๐
